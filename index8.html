<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰∫íÂãïÂºèÁ∂≤Ë∑ØÂúñ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 300;
            letter-spacing: 2px;
        }

        /* Êñ∞Â¢û‰∏ªË¶ÅÂÖßÂÆπÂÆπÂô® */
        .main-content {
            display: flex;
            height: 700px;
        }

        .controls {
            width: 350px;
            padding: 30px;
            background: rgba(102, 126, 234, 0.05);
            display: flex;
            flex-direction: column;
            gap: 30px;
            overflow-y: auto;
            border-right: 1px solid #e1e8ed;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .control-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 0.9rem;
        }

        .search-container {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 14px;
            background: white;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e1e8ed;
            border-top: none;
            border-radius: 0 0 10px 10px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .search-suggestion {
            padding: 10px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }

        .search-suggestion:hover {
            background-color: rgba(102, 126, 234, 0.1);
        }

        .search-suggestion:last-child {
            border-bottom: none;
        }

        .search-suggestion.highlighted {
            background-color: rgba(102, 126, 234, 0.15);
        }

        .search-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .search-btn {
            flex: 1;
            padding: 8px 12px;
            font-size: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-btn.focus {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .search-btn.clear {
            background: #f8f9fa;
            color: #666;
            border: 1px solid #e1e8ed;
        }

        .search-btn:hover {
            transform: translateY(-1px);
        }

        .multi-select-container {
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            background: white;
            max-height: 150px;
            overflow-y: auto;
            padding: 8px;
        }

        .multi-select-container:focus-within {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 4px 8px;
            margin: 2px 0;
            border-radius: 6px;
            transition: background-color 0.2s;
        }

        .checkbox-item:hover {
            background-color: rgba(102, 126, 234, 0.1);
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 8px;
            width: 14px;
            height: 14px;
        }

        .checkbox-item label {
            font-size: 12px;
            font-weight: normal;
            margin: 0;
            cursor: pointer;
            flex: 1;
        }

        button {
            padding: 12px 16px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        button:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .layout-toggle {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .layout-btn {
            width: 100%;
            padding: 10px;
            font-size: 12px;
        }

        .layout-btn.active {
            background: linear-gradient(45deg, #764ba2, #667eea);
        }

        .zoom-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }

        .zoom-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: rgba(102, 126, 234, 0.9);
            color: white;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .zoom-btn:hover {
            background: rgba(102, 126, 234, 1);
            transform: scale(1.1);
        }

        #network-container {
            flex: 1;
            height: 700px;
            position: relative;
            overflow: hidden;
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 12px;
            pointer-events: auto;
            z-index: 1000;
            max-width: 350px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        .tooltip h4 {
            margin: 0 0 8px 0;
            color: #667eea;
            font-size: 14px;
        }

        .tooltip p {
            margin: 4px 0;
            line-height: 1.4;
        }

        .tooltip a {
            color: #87ceeb;
            text-decoration: none;
        }

        .tooltip a:hover {
            text-decoration: underline;
        }

        .tooltip .link-entry {
            border-left: 3px solid #667eea;
            padding-left: 10px;
            margin: 8px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            padding: 8px 0 8px 10px;
        }

        .tooltip .link-entry:not(:last-child) {
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 8px;
            margin-bottom: 8px;
        }

        .legend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            font-size: 12px;
            max-height: 400px;
            min-width: 180px;
            z-index: 1000;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .legend-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            cursor: pointer;
            user-select: none;
        }

        .legend-header h4 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
        }

        .legend-toggle {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            font-size: 12px;
            font-weight: bold;
        }

        .legend-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .legend-content {
            padding: 20px;
            max-height: 350px;
            overflow-y: auto;
            transition: all 0.3s ease;
        }

        .legend.collapsed .legend-content {
            max-height: 0;
            padding: 0 20px;
            overflow: hidden;
        }

        .legend.collapsed .legend-toggle {
            transform: rotate(180deg);
        }

        .legend-section {
            margin-bottom: 15px;
        }

        .legend-section:last-child {
            margin-bottom: 0;
        }

        .legend-section h5 {
            margin: 0 0 8px 0;
            color: #333;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }

        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 8px;
            flex-shrink: 0;
        }

        .legend-line {
            width: 20px;
            height: 2px;
            margin-right: 8px;
            flex-shrink: 0;
        }

        .legend-dashed {
            width: 20px;
            height: 2px;
            margin-right: 8px;
            flex-shrink: 0;
            background: repeating-linear-gradient(
                to right,
                #666 0px,
                #666 4px,
                transparent 4px,
                transparent 8px
            );
        }

        .node-text {
            font-size: 11px;
            font-weight: 600;
            text-anchor: middle;
            dominant-baseline: middle;
            fill: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
        }

        .link {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .link:hover {
            filter: brightness(1.3);
            stroke-width: 4px !important;
        }

        .link.multi-link {
            stroke-dasharray: 5,5;
            animation: dash 1s linear infinite;
        }

        @keyframes dash {
            to {
                stroke-dashoffset: -10;
            }
        }

        .node {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .node:hover {
            filter: brightness(1.2) drop-shadow(0 0 8px rgba(0,0,0,0.4));
        }

        .node.focused {
            filter: brightness(1.3) drop-shadow(0 0 15px rgba(102, 126, 234, 0.8));
            stroke: #667eea;
            stroke-width: 3px;
        }

        .node.dimmed {
            opacity: 0.3;
        }

        .link.dimmed {
            opacity: 0.2;
        }

        .node-text.dimmed {
            opacity: 0.3;
        }

        .select-all-btn {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #e1e8ed;
            padding: 4px 8px;
            margin-bottom: 8px;
            font-size: 11px;
            text-transform: none;
            letter-spacing: normal;
        }

        .select-all-btn:hover {
            background: #e9ecef;
            transform: none;
            box-shadow: none;
        }
        
        .layer-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .layer-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .layer-btn {
            flex: 1;
            min-width: 45px;
            padding: 8px 10px;
            font-size: 12px;
            background: #f8f9fa;
            color: #666;
            border: 1px solid #e1e8ed;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: none;
            letter-spacing: normal;
            font-weight: 500;
        }
        
        .layer-btn:hover {
            background: #e9ecef;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .layer-btn.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
        }
        
        .layer-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        .layer-info {
            font-size: 11px;
            color: #666;
            text-align: center;
            padding: 5px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 6px;
            line-height: 1.3;
        }

        .no-data-message {
            text-align: center;
            color: #666;
            font-size: 18px;
            padding: 50px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Á∂≤Ë∑ØÈóú‰øÇÂúñ</h1>
        </div>
    
    <div class="main-content">    
        <div class="controls">
            <div class="control-group">
                <label>ÊêúÂ∞ãÁØÄÈªû</label>
                <div class="search-container">
                    <input type="text" class="search-input" id="nodeSearch" placeholder="Ëº∏ÂÖ•ÁØÄÈªûÂêçÁ®±..." autocomplete="off">
                    <div class="search-suggestions" id="searchSuggestions"></div>
                </div>
                <div class="search-buttons">
                    <button class="search-btn focus" onclick="focusOnSearchedNode()">ËÅöÁÑ¶</button>
                    <button class="search-btn clear" onclick="clearSearch()">Ê∏ÖÈô§</button>
                </div>
            </div>
            
            <div class="control-group">
                <label>ÈÄ£ÁµêÂ±§Á¥ö</label>
                <div class="layer-controls" id="layerControls">
                    <div class="layer-buttons">
                        <button class="layer-btn active" data-layer="1">1Â±§</button>
                        <button class="layer-btn" data-layer="2">2Â±§</button>
                        <button class="layer-btn" data-layer="3">3Â±§</button>
                        <button class="layer-btn" data-layer="4">4Â±§</button>
                        <button class="layer-btn" data-layer="5">5Â±§</button>
                    </div>
                    <div class="layer-info">
                        <span id="layerInfo">ÈÅ∏Êìá‰∏≠ÂøÉÁØÄÈªûÂæåÂèØË™øÊï¥Â±§Á¥ö</span>
                    </div>
                </div>
            </div>
            
            <div class="control-group">
                <label>Âπ¥‰ªΩÁØ©ÈÅ∏</label>
                <button class="select-all-btn" onclick="toggleSelectAll('linkYear')">ÂÖ®ÈÅ∏/ÂèñÊ∂àÂÖ®ÈÅ∏</button>
                <div class="multi-select-container" id="linkYearSelect">
                </div>
            </div>
            
            <div class="control-group">
                <label>ÈÄ£ÁµêÈ°ûÂûã</label>
                <button class="select-all-btn" onclick="toggleSelectAll('linkType')">ÂÖ®ÈÅ∏/ÂèñÊ∂àÂÖ®ÈÅ∏</button>
                <div class="multi-select-container" id="linkTypeSelect">
                </div>
            </div>
            
            <div class="control-group">
                <label>ÂúñÂΩ¢ÈÅ∏Êìá</label>
                <div class="layout-toggle">
                    <button class="layout-btn active" data-layout="force">Ê®πÁãÄÁ∂≤Ë∑ØÂúñ</button>
                    <button class="layout-btn" data-layout="circle">ÂúìÂΩ¢Á∂≤Ë∑ØÂúñ</button>
                </div>
            </div>
        </div>

        
        <div id="network-container">
            <div class="legend collapsed" id="legend">
                <div class="legend-header" onclick="toggleLegend()">
                    <h4>Âúñ‰æã</h4>
                    <div class="legend-toggle">‚Üë</div>
                </div>
                <div class="legend-content" id="legend-content">
                    <!-- Âúñ‰æãÂÖßÂÆπÂ∞áÁî± JavaScript ÂãïÊÖãÁîüÊàê -->
                </div>
            </div>
            <div class="zoom-controls">
                <button class="zoom-btn" id="zoom-in">+</button>
                <button class="zoom-btn" id="zoom-out">‚àí</button>
                <button class="zoom-btn" id="zoom-reset" title="ÈáçÁΩÆÁ∏ÆÊîæ">‚åÇ</button>
            </div>
        </div>
        </div>    
    </div>

    <div class="tooltip" id="tooltip" style="display: none;"></div>

    <script>
        // ÂÖ®ÂüüËÆäÊï∏
        let currentLayout = 'force';
        let filteredNodes = [];
        let filteredLinks = [];
        let consolidatedLinks = [];
        let svg, simulation, tooltip, zoom, g;
        let fixedTooltip = null;
        let searchedNode = null;
        let suggestionsVisible = false;
        let highlightedSuggestion = -1;

        // ÂéüÂßãË≥áÊñô
        let sampleNodes = [];
        let sampleLinks = [];

        // ÈÅ∏‰∏≠ÁöÑÁØ©ÈÅ∏È†ÖÁõÆ - È†êË®≠ÁÇ∫Á©∫Èô£ÂàóÔºàÊ≤íÊúâÈÅ∏Âèñ‰ªª‰ΩïÈ†ÖÁõÆÔºâ
        let selectedFilters = {
            linkYear: [],
            linkType: []
        };

        // ÊòØÂê¶Â∑≤Á∂ìÂàùÂßãÂåñË¶ñË¶∫Âåñ
        let visualizationInitialized = false;
        
        // ÊòØÂê¶Â∑≤ÈÅ∏ÊìáÂàùÂßãÁØÄÈªû
        let initialNodeSelected = false;
        
        // Áï∂ÂâçÈÅ∏ÊìáÁöÑ‰∏≠ÂøÉÁØÄÈªû
        let centerNode = null;
        
        // Áï∂ÂâçÈÅ∏ÊìáÁöÑÂ±§Á¥öÊï∏
        let selectedLayers = 1;

        // ÂãïÊÖãÈ°èËâ≤ÈÖçÁΩÆ
        let nodeColors = {};
        let linkColors = {};

        // È†êÂÆöÁæ©ÁöÑÈ°èËâ≤Ë™øËâ≤Êùø
        const colorPalettes = {
            nodes: [
                "#ff6b6b", "#4ecdc4", "#45b7d1", "#96ceb4", "#feca57",
                "#ff9ff3", "#54a0ff", "#5f27cd", "#00d2d3", "#ff9f43",
                "#ee5a24", "#10ac84", "#f368e0", "#6c5ce7", "#a55eea",
                "#26de81", "#fd79a8", "#fdcb6e", "#e17055", "#74b9ff"
            ],
            links: [
                "#ff9ff3", "#54a0ff", "#5f27cd", "#00d2d3", "#ff9f43",
                "#ee5a24", "#10ac84", "#f368e0", "#6c5ce7", "#a55eea",
                "#26de81", "#fd79a8", "#fdcb6e", "#e17055", "#74b9ff",
                "#fd63a3", "#6c5ce7", "#a29bfe", "#00b894", "#e84393"
            ]
        };

        // Âúñ‰æãÊî∂ÂêàÂäüËÉΩ
        function toggleLegend() {
            const legend = document.getElementById('legend');
            legend.classList.toggle('collapsed');
        }

        // ÊêúÂ∞ãÂäüËÉΩ
        function setupSearchFunctionality() {
            const searchInput = document.getElementById('nodeSearch');
            const suggestionsContainer = document.getElementById('searchSuggestions');

            searchInput.addEventListener('input', function(e) {
                const query = e.target.value.toLowerCase().trim();
                
                if (query.length === 0) {
                    hideSuggestions();
                    return;
                }

                const matchingNodes = sampleNodes.filter(node => 
                    node.name.toLowerCase().includes(query)
                );

                if (matchingNodes.length > 0) {
                    showSuggestions(matchingNodes, query);
                } else {
                    hideSuggestions();
                }
            });

            searchInput.addEventListener('keydown', function(e) {
                if (!suggestionsVisible) return;

                const suggestions = suggestionsContainer.querySelectorAll('.search-suggestion');
                
                switch(e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        highlightedSuggestion = Math.min(highlightedSuggestion + 1, suggestions.length - 1);
                        updateHighlight(suggestions);
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        highlightedSuggestion = Math.max(highlightedSuggestion - 1, -1);
                        updateHighlight(suggestions);
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (highlightedSuggestion >= 0) {
                            selectSuggestion(suggestions[highlightedSuggestion].textContent);
                        }
                        break;
                    case 'Escape':
                        hideSuggestions();
                        searchInput.blur();
                        break;
                }
            });

            searchInput.addEventListener('blur', function() {
                // Âª∂ÈÅ≤Èö±ËóèÂª∫Ë≠∞ÔºåËÆìÈªûÊìäÂª∫Ë≠∞È†ÖÁõÆÊúâÊôÇÈñìÂü∑Ë°å
                setTimeout(() => {
                    hideSuggestions();
                }, 200);
            });

            // ÈªûÊìäÊêúÂ∞ãÊ°ÜÂ§ñÈÉ®ÊôÇÈö±ËóèÂª∫Ë≠∞
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.search-container')) {
                    hideSuggestions();
                }
            });
        }

        function showSuggestions(nodes, query) {
            const suggestionsContainer = document.getElementById('searchSuggestions');
            suggestionsContainer.innerHTML = '';
            
            // ÈôêÂà∂È°ØÁ§∫ÁöÑÂª∫Ë≠∞Êï∏Èáè
            const maxSuggestions = 8;
            const nodesToShow = nodes.slice(0, maxSuggestions);
            
            nodesToShow.forEach((node, index) => {
                const suggestionDiv = document.createElement('div');
                suggestionDiv.className = 'search-suggestion';
                
                // È´ò‰∫ÆÂåπÈÖçÁöÑÈÉ®ÂàÜ
                const highlightedName = highlightMatch(node.name, query);
                suggestionDiv.innerHTML = `${highlightedName} <span style="color: #666; font-size: 11px;">(${node.type})</span>`;
                
                suggestionDiv.addEventListener('click', function() {
                    selectSuggestion(node.name);
                });
                
                suggestionsContainer.appendChild(suggestionDiv);
            });
            
            suggestionsContainer.style.display = 'block';
            suggestionsVisible = true;
            highlightedSuggestion = -1;
        }

        function hideSuggestions() {
            const suggestionsContainer = document.getElementById('searchSuggestions');
            suggestionsContainer.style.display = 'none';
            suggestionsVisible = false;
            highlightedSuggestion = -1;
        }

        function updateHighlight(suggestions) {
            suggestions.forEach((suggestion, index) => {
                suggestion.classList.toggle('highlighted', index === highlightedSuggestion);
            });
        }

        function highlightMatch(text, query) {
            const index = text.toLowerCase().indexOf(query.toLowerCase());
            if (index === -1) return text;
            
            return text.substring(0, index) + 
                   '<strong style="color: #667eea;">' + 
                   text.substring(index, index + query.length) + 
                   '</strong>' + 
                   text.substring(index + query.length);
        }

        function selectSuggestion(nodeName) {
            const searchInput = document.getElementById('nodeSearch');
            searchInput.value = nodeName;
            hideSuggestions();
            
            // Ë®≠ÁΩÆÊêúÂ∞ãÁöÑÁØÄÈªû
            searchedNode = nodeName;
            
            // Ëá™ÂãïËÅöÁÑ¶Âà∞Ë©≤ÁØÄÈªû
            focusOnSearchedNode();
        }

        function focusOnSearchedNode() {
            const searchInput = document.getElementById('nodeSearch');
            const nodeName = searchInput.value.trim();
            
            if (!nodeName) {
                alert('Ë´ãËº∏ÂÖ•Ë¶ÅÊêúÂ∞ãÁöÑÁØÄÈªûÂêçÁ®±');
                return;
            }

            const targetNode = sampleNodes.find(node => 
                node.name.toLowerCase() === nodeName.toLowerCase()
            );

            if (!targetNode) {
                alert('Êâæ‰∏çÂà∞Ë©≤ÁØÄÈªûÔºåË´ãÊ™¢Êü•ÁØÄÈªûÂêçÁ®±');
                return;
            }

            // Ë®≠ÂÆö‰∏≠ÂøÉÁØÄÈªûÂíåÊêúÂ∞ãÁØÄÈªû
            centerNode = targetNode.name;
            searchedNode = targetNode.name;
            initialNodeSelected = true;
            
            // ÁØ©ÈÅ∏Âá∫Á¨¨‰∏ÄÂ±§ÈÄ£ÁµêÁöÑË≥áÊñô
            filterDataForCenterNode();
            
            // ÂïüÁî®ÁØ©ÈÅ∏ÊéßÂà∂È†Ö
            enableFilterControls();
            
            // ÂïüÁî®Â±§Á¥öÊéßÂà∂
            enableLayerControls();
            
            // ÂâµÂª∫ÊàñÊõ¥Êñ∞Ë¶ñË¶∫Âåñ
            if (!visualizationInitialized) {
                createVisualization();
                visualizationInitialized = true;
            } else {
                updateVisualization();
            }
            
            // Â∞áË¶ñÂúñ‰∏≠ÂøÉÁßªÂãïÂà∞ÁõÆÊ®ôÁØÄÈªû
            setTimeout(() => {
                const targetNodeInFiltered = filteredNodes.find(node => node.name === targetNode.name);
                if (targetNodeInFiltered) {
                    centerOnNode(targetNodeInFiltered);
                }
            }, 500);
        }

        function centerOnNode(targetNode) {
            if (!svg || !targetNode) return;

            const container = document.getElementById('network-container');
            const width = container.clientWidth;
            const height = container.clientHeight;

            // Ë®àÁÆóÈúÄË¶ÅÁöÑËÆäÊèõ
            const scale = 1.5; // ÊîæÂ§ßÂÄçÊï∏
            const translateX = width / 2 - targetNode.x * scale;
            const translateY = height / 2 - targetNode.y * scale;

            // Âπ≥ÊªëÈÅéÊ∏°Âà∞ÁõÆÊ®ô‰ΩçÁΩÆ
            svg.transition()
                .duration(1000)
                .call(zoom.transform, d3.zoomIdentity
                    .translate(translateX, translateY)
                    .scale(scale));
        }

        function clearSearch() {
            const searchInput = document.getElementById('nodeSearch');
            searchInput.value = '';
            searchedNode = null;
            centerNode = null;
            initialNodeSelected = false;
            selectedLayers = 1; // ÈáçÁΩÆÂ±§Á¥öÁÇ∫1
            hideSuggestions();
            
            // ÁßªÈô§ÊâÄÊúâÁØ©ÈÅ∏
            selectedFilters.linkYear = [];
            selectedFilters.linkType = [];
            
            // Á¶ÅÁî®ÁØ©ÈÅ∏ÊéßÂà∂È†Ö
            disableFilterControls();
            
            // Á¶ÅÁî®Â±§Á¥öÊéßÂà∂
            disableLayerControls();
            
            // Ê∏ÖÁ©∫ÁØ©ÈÅ∏ÈÅ∏È†Ö
            clearFilterSelections();
            
            // ÈáçÁΩÆË¶ñË¶∫Âåñ
            if (visualizationInitialized) {
                showInitialMessage();
                visualizationInitialized = false;
            }
        }

        // Âêà‰ΩµÁõ∏ÂêåfromÂíåtoÁöÑÈÄ£Áµê
        function consolidateLinks(links) {
            const linkMap = new Map();
            
            links.forEach(link => {
                const key = `${link.from}-${link.to}`;
                if (linkMap.has(key)) {
                    linkMap.get(key).entries.push({
                        type: link.type,
                        year: link.year,
                        url: link.url
                    });
                } else {
                    linkMap.set(key, {
                        from: link.from,
                        to: link.to,
                        entries: [{
                            type: link.type,
                            year: link.year,
                            url: link.url
                        }]
                    });
                }
            });
            
            return Array.from(linkMap.values()).map(consolidatedLink => {
                const primaryEntry = consolidatedLink.entries[0];
                const allTypes = [...new Set(consolidatedLink.entries.map(e => e.type))];
                const allYears = [...new Set(consolidatedLink.entries.map(e => e.year))].sort((a, b) => b - a);
                
                return {
                    ...consolidatedLink,
                    type: primaryEntry.type,
                    year: primaryEntry.year,
                    url: primaryEntry.url,
                    allTypes: allTypes,
                    allYears: allYears,
                    isMultiLink: consolidatedLink.entries.length > 1,
                    linkCount: consolidatedLink.entries.length
                };
            });
        }

        // ÂãïÊÖãÁîüÊàêÈ°èËâ≤ÈÖçÁΩÆ
        function generateColors() {
            console.log('ÁîüÊàêÂãïÊÖãÈ°èËâ≤ÈÖçÁΩÆ...');
            
            const nodeTypes = [...new Set(sampleNodes.map(node => node.type))];
            nodeColors = {};
            nodeTypes.forEach((type, index) => {
                nodeColors[type] = colorPalettes.nodes[index % colorPalettes.nodes.length];
            });

            const linkTypes = [...new Set(sampleLinks.map(link => link.type))];
            linkColors = {};
            linkTypes.forEach((type, index) => {
                linkColors[type] = colorPalettes.links[index % colorPalettes.links.length];
            });

            console.log('ÁØÄÈªûÈ°èËâ≤ÈÖçÁΩÆ:', nodeColors);
            console.log('ÈÄ£ÁµêÈ°èËâ≤ÈÖçÁΩÆ:', linkColors);
        }

        // ËºâÂÖ•Â§ñÈÉ®Ë≥áÊñô
        async function loadData() {
            try {
                console.log('ÈñãÂßãËºâÂÖ•Ë≥áÊñô...');
                
                const [nodesResponse, linksResponse] = await Promise.all([
                    fetch('./nodes.json'),
                    fetch('./links.json')
                ]);

                if (!nodesResponse.ok) {
                    throw new Error(`ËºâÂÖ•ÁØÄÈªûË≥áÊñôÂ§±Êïó: ${nodesResponse.status}`);
                }
                if (!linksResponse.ok) {
                    throw new Error(`ËºâÂÖ•ÈÄ£ÁµêË≥áÊñôÂ§±Êïó: ${linksResponse.status}`);
                }

                sampleNodes = await nodesResponse.json();
                sampleLinks = await linksResponse.json();

                console.log('Ë≥áÊñôËºâÂÖ•ÊàêÂäü:', { nodes: sampleNodes.length, links: sampleLinks.length });

                generateColors();
                init();

            } catch (error) {
                console.error('ËºâÂÖ•Ë≥áÊñôÊôÇÁôºÁîüÈåØË™§:', error);
                
                console.log('‰ΩøÁî®ÂÖßÂª∫ÁØÑ‰æãË≥áÊñô...');
                sampleNodes = [
                    { name: "Âè∞ÂåóÂ∏ÇÊîøÂ∫ú", type: "ÊîøÂ∫úÊ©üÈóú" },
                    { name: "Êñ∞ÂåóÂ∏ÇÊîøÂ∫ú", type: "ÊîøÂ∫úÊ©üÈóú" },
                    { name: "Âè∞Á©çÈõª", type: "ÁßëÊäÄÂÖ¨Âè∏" },
                    { name: "È¥ªÊµ∑", type: "ÁßëÊäÄÂÖ¨Âè∏" },
                    { name: "Âè∞ÁÅ£Â§ßÂ≠∏", type: "ÊïôËÇ≤Ê©üÊßã" },
                    { name: "Ê∏ÖËèØÂ§ßÂ≠∏", type: "ÊïôËÇ≤Ê©üÊßã" },
                    { name: "‰∏≠Á†îÈô¢", type: "Á†îÁ©∂Ê©üÊßã" },
                    { name: "Â∑•Á†îÈô¢", type: "Á†îÁ©∂Ê©üÊßã" },
                    { name: "Âè∞ÂåóÈÜ´Â≠∏Â§ßÂ≠∏", type: "ÊïôËÇ≤Ê©üÊßã" },
                    { name: "Èï∑Â∫öÈÜ´Èô¢", type: "ÈÜ´ÁôÇÊ©üÊßã" },
                    { name: "Âè∞Â§ßÈÜ´Èô¢", type: "ÈÜ´ÁôÇÊ©üÊßã" },
                    { name: "ËÅØÁôºÁßë", type: "ÁßëÊäÄÂÖ¨Âè∏" },
                    { name: "Âè∞ÈÅîÈõª", type: "ÁßëÊäÄÂÖ¨Âè∏" },
                    { name: "ÊàêÂäüÂ§ßÂ≠∏", type: "ÊïôËÇ≤Ê©üÊßã" },
                    { name: "È´òÈõÑÂ∏ÇÊîøÂ∫ú", type: "ÊîøÂ∫úÊ©üÈóú" }
                ];

                sampleLinks = [
                    { from: "Âè∞ÂåóÂ∏ÇÊîøÂ∫ú", to: "Âè∞ÁÅ£Â§ßÂ≠∏", type: "Âêà‰ΩúÂçîË≠∞", year: 2023, url: "https://example.com/agreement1" },
                    { from: "Âè∞ÂåóÂ∏ÇÊîøÂ∫ú", to: "Âè∞ÁÅ£Â§ßÂ≠∏", type: "Á†îÁ©∂Ë≥áÂä©", year: 2022, url: "https://example.com/funding1" },
                    { from: "Âè∞Á©çÈõª", to: "Ê∏ÖËèØÂ§ßÂ≠∏", type: "Áî¢Â≠∏Âêà‰Ωú", year: 2022, url: "https://example.com/cooperation1" },
                    { from: "Âè∞Á©çÈõª", to: "Ê∏ÖËèØÂ§ßÂ≠∏", type: "‰∫∫ÊâçÂüπËÇ≤", year: 2023, url: "https://example.com/talent2" },
                    { from: "È¥ªÊµ∑", to: "Â∑•Á†îÈô¢", type: "ÊäÄË°ìËΩâÁßª", year: 2022, url: "https://example.com/tech-transfer1" },
                    { from: "‰∏≠Á†îÈô¢", to: "Âè∞ÁÅ£Â§ßÂ≠∏", type: "Â≠∏Ë°ì‰∫§ÊµÅ", year: 2021, url: "https://example.com/academic1" },
                    { from: "Êñ∞ÂåóÂ∏ÇÊîøÂ∫ú", to: "Âè∞ÂåóÈÜ´Â≠∏Â§ßÂ≠∏", type: "ÊîøÁ≠ñÂêà‰Ωú", year: 2023, url: "https://example.com/policy1" },
                    { from: "Èï∑Â∫öÈÜ´Èô¢", to: "Âè∞Â§ßÈÜ´Èô¢", type: "ÈÜ´ÁôÇËÅØÁõü", year: 2023, url: "https://example.com/medical1" },
                    { from: "Èï∑Â∫öÈÜ´Èô¢", to: "Âè∞Â§ßÈÜ´Èô¢", type: "Ë®≠ÂÇôÂÖ±‰∫´", year: 2022, url: "https://example.com/equipment1" },
                    { from: "ËÅØÁôºÁßë", to: "ÊàêÂäüÂ§ßÂ≠∏", type: "Áî¢Â≠∏Âêà‰Ωú", year: 2023, url: "https://example.com/cooperation2" },
                    { from: "Âè∞ÈÅîÈõª", to: "Ê∏ÖËèØÂ§ßÂ≠∏", type: "Á†îÁôºÂêà‰Ωú", year: 2022, url: "https://example.com/rd1" },
                    { from: "È´òÈõÑÂ∏ÇÊîøÂ∫ú", to: "ÊàêÂäüÂ§ßÂ≠∏", type: "ÂçÄÂüüÁôºÂ±ï", year: 2021, url: "https://example.com/regional1" },
                    { from: "Â∑•Á†îÈô¢", to: "Âè∞Á©çÈõª", type: "ÊäÄË°ìË´ÆË©¢", year: 2020, url: "https://example.com/consulting1" },
                    { from: "Âè∞ÁÅ£Â§ßÂ≠∏", to: "Âè∞Â§ßÈÜ´Èô¢", type: "ÈôÑÂ±¨Èóú‰øÇ", year: 2021, url: "https://example.com/affiliation1" },
                    { from: "‰∏≠Á†îÈô¢", to: "Ê∏ÖËèØÂ§ßÂ≠∏", type: "‰∫∫Êâç‰∫§ÊµÅ", year: 2020, url: "https://example.com/talent1" },
                    { from: "È¥ªÊµ∑", to: "ËÅØÁôºÁßë", type: "‰æõÊáâÈèà", year: 2022, url: "https://example.com/supply1" },
                    { from: "Âè∞ÂåóÂ∏ÇÊîøÂ∫ú", to: "Êñ∞ÂåóÂ∏ÇÊîøÂ∫ú", type: "Ë∑®ÂüüÂêà‰Ωú", year: 2023, url: "https://example.com/cross-region1" },
                    { from: "Âè∞ÂåóÈÜ´Â≠∏Â§ßÂ≠∏", to: "Èï∑Â∫öÈÜ´Èô¢", type: "ÂØ¶ÁøíÂêà‰Ωú", year: 2022, url: "https://example.com/internship1" }
                ];

                generateColors();
                init();
            }
        }

        // ÂàùÂßãÂåñ
        function init() {
            setupMultiSelectors();
            setupEventListeners();
            setupZoomControls();
            setupSearchFunctionality();
            setupLayerControls(); // Ë®≠ÁΩÆÂ±§Á¥öÊéßÂà∂
            disableFilterControls(); // ÂàùÂßãÁãÄÊÖãÁ¶ÅÁî®ÁØ©ÈÅ∏ÊéßÂà∂
            disableLayerControls(); // ÂàùÂßãÁãÄÊÖãÁ¶ÅÁî®Â±§Á¥öÊéßÂà∂
            showInitialMessage(); // È°ØÁ§∫ÂàùÂßãÊèêÁ§∫Ë®äÊÅØ
            updateLegend();
        }

        // Ë®≠ÁΩÆÂ§öÈÅ∏ÈÅ∏ÊìáÂô® - ‰øÆÊîπÁÇ∫È†êË®≠Êú™ÈÅ∏Âèñ
        function setupMultiSelectors() {
            const linkYears = [...new Set(sampleLinks.map(d => d.year))].sort((a, b) => b - a);
            const linkTypes = [...new Set(sampleLinks.map(d => d.type))];

            // ÂàùÂßãÂåñÊâÄÊúâÈ†ÖÁõÆÁÇ∫Êú™ÈÅ∏‰∏≠ÁãÄÊÖã
            selectedFilters.linkYear = [];
            selectedFilters.linkType = [];

            createMultiSelect('linkYearSelect', linkYears, 'linkYear');
            createMultiSelect('linkTypeSelect', linkTypes, 'linkType');
        }

        function createMultiSelect(containerId, options, filterType) {
            const container = document.getElementById(containerId);
            
            options.forEach(option => {
                const item = document.createElement('div');
                item.className = 'checkbox-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `${filterType}_${option}`;
                checkbox.value = option;
                checkbox.checked = false; // È†êË®≠ÁÇ∫Êú™ÈÅ∏Âèñ
                checkbox.addEventListener('change', () => updateFilter(filterType, option, checkbox.checked));
                
                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = option;
                
                item.appendChild(checkbox);
                item.appendChild(label);
                container.appendChild(item);
            });
        }

        function updateFilter(filterType, value, isChecked) {
            // Âè™ÊúâÂú®Â∑≤ÈÅ∏ÊìáÂàùÂßãÁØÄÈªûÂæåÊâçËÉΩ‰ΩøÁî®ÁØ©ÈÅ∏
            if (!initialNodeSelected) {
                return;
            }
            
            if (isChecked) {
                if (!selectedFilters[filterType].includes(value)) {
                    selectedFilters[filterType].push(value);
                }
            } else {
                selectedFilters[filterType] = selectedFilters[filterType].filter(item => item !== value);
            }
            
            // ÁØ©ÈÅ∏‰ª•‰∏≠ÂøÉÁØÄÈªûÁÇ∫Âü∫Á§éÁöÑË≥áÊñô
            filterDataForCenterNode();
            
            // Êõ¥Êñ∞Ë¶ñË¶∫Âåñ
            updateVisualization();
        }

        function toggleSelectAll(filterType) {
            // Âè™ÊúâÂú®Â∑≤ÈÅ∏ÊìáÂàùÂßãÁØÄÈªûÂæåÊâçËÉΩ‰ΩøÁî®ÁØ©ÈÅ∏
            if (!initialNodeSelected) {
                return;
            }
            
            const container = document.getElementById(`${filterType}Select`);
            const checkboxes = container.querySelectorAll('input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
            });
            
            // ÊâπÊ¨°Êõ¥Êñ∞ÁØ©ÈÅ∏Ê¢ù‰ª∂
            if (!allChecked) {
                // ÂÖ®ÈÅ∏
                selectedFilters[filterType] = Array.from(checkboxes).map(cb => cb.value);
            } else {
                // ÂèñÊ∂àÂÖ®ÈÅ∏
                selectedFilters[filterType] = [];
            }
            
            // ÁØ©ÈÅ∏‰ª•‰∏≠ÂøÉÁØÄÈªûÁÇ∫Âü∫Á§éÁöÑË≥áÊñô
            filterDataForCenterNode();
            
            // Êõ¥Êñ∞Ë¶ñË¶∫Âåñ
            updateVisualization();
        }

        // Ë®≠ÁΩÆ‰∫ã‰ª∂Áõ£ËÅΩÂô®
        function setupEventListeners() {
            document.querySelectorAll('.layout-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.layout-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    currentLayout = e.target.dataset.layout;
                    updateVisualization();
                });
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.link') && !e.target.closest('.tooltip') && !e.target.closest('.tooltip-link')) {
                    hideFixedTooltip();
                }
            });
        }

        // Ë®≠ÁΩÆÁ∏ÆÊîæÊéßÂà∂
        function setupZoomControls() {
            document.getElementById('zoom-in').addEventListener('click', () => {
                svg.transition().call(zoom.scaleBy, 1.5);
            });

            document.getElementById('zoom-out').addEventListener('click', () => {
                svg.transition().call(zoom.scaleBy, 1 / 1.5);
            });

            document.getElementById('zoom-reset').addEventListener('click', () => {
                svg.transition().call(zoom.transform, d3.zoomIdentity);
            });
        }

        // È°ØÁ§∫ÂàùÂßãÊèêÁ§∫Ë®äÊÅØ
        function showInitialMessage() {
            const container = document.getElementById('network-container');
            
            // Ê∏ÖÈô§ÁèæÊúâÂÖßÂÆπ
            d3.select('#network-container svg').remove();
            d3.select('#network-container .initial-message').remove();
            
            // ÂâµÂª∫ÊèêÁ§∫Ë®äÊÅØ
            const messageDiv = d3.select('#network-container')
                .append('div')
                .attr('class', 'initial-message')
                .style('display', 'flex')
                .style('flex-direction', 'column')
                .style('align-items', 'center')
                .style('justify-content', 'center')
                .style('height', '100%')
                .style('text-align', 'center')
                .style('color', '#666')
                .style('font-size', '18px')
                .style('padding', '50px');
            
            messageDiv.append('div')
                .style('font-size', '4rem')
                .style('margin-bottom', '20px')
                .style('opacity', '0.3')
                .text('üîç');
            
            messageDiv.append('h3')
                .style('margin', '0 0 15px 0')
                .style('color', '#333')
                .style('font-weight', 'normal')
                .text('Ê≠°Ëøé‰ΩøÁî®Á∂≤Ë∑ØÈóú‰øÇÂúñ');
            
            messageDiv.append('p')
                .style('margin', '0 0 10px 0')
                .style('line-height', '1.6')
                .style('color', '#333')
                .style('font-weight', '500')
                .text('Ë´ãÂÖàÊêúÂ∞ã‰∏ÄÂÄãÁØÄÈªû‰æÜÈñãÂßãÊé¢Á¥¢');
            
            messageDiv.append('p')
                .style('margin', '0')
                .style('font-size', '14px')
                .style('opacity', '0.8')
                .text('ÊêúÂ∞ãÂæåÂ∞áÈ°ØÁ§∫Ë©≤ÁØÄÈªûÂèäÂÖ∂Á¨¨‰∏ÄÂ±§ÈÄ£ÁµêÔºåÁÑ∂ÂæåÂèØ‰ª•ÈÄ≤Ë°åÁØ©ÈÅ∏');
            
            // ÈáçÁΩÆÁõ∏ÈóúËÆäÊï∏
            filteredNodes = [];
            filteredLinks = [];
            consolidatedLinks = [];
            searchedNode = null;
            
            // Ê∏ÖÁ©∫ÊêúÂ∞ãÊ°Ü
            const searchInput = document.getElementById('nodeSearch');
            if (searchInput) {
                searchInput.value = '';
            }
            
            // Êõ¥Êñ∞Âúñ‰æã
            updateLegend();
        }

        // ÁØ©ÈÅ∏‰ª•‰∏≠ÂøÉÁØÄÈªûÁÇ∫Âü∫Á§éÁöÑË≥áÊñô
        function filterDataForCenterNode() {
            if (!centerNode) {
                filteredNodes = [];
                filteredLinks = [];
                consolidatedLinks = [];
                return;
            }
            
            // ÊâæÂá∫ÊåáÂÆöÂ±§Á¥öÁöÑÊâÄÊúâÈÄ£Áµê
            const layerLinks = getLinksUpToLayer(centerNode, selectedLayers);
            
            // Ê†πÊìöÂπ¥‰ªΩÂíåÈ°ûÂûãÁØ©ÈÅ∏ÈÄ£Áµê
            filteredLinks = layerLinks.filter(link => {
                return (selectedFilters.linkYear.length === 0 || selectedFilters.linkYear.includes(link.year)) &&
                       (selectedFilters.linkType.length === 0 || selectedFilters.linkType.includes(link.type));
            });
            
            // Â¶ÇÊûúÊ≤íÊúâÁØ©ÈÅ∏Ê¢ù‰ª∂ÔºåÂ∞±È°ØÁ§∫ÊâÄÊúâÊåáÂÆöÂ±§Á¥öÁöÑÈÄ£Áµê
            if (selectedFilters.linkYear.length === 0 && selectedFilters.linkType.length === 0) {
                filteredLinks = layerLinks;
            }
            
            // Êî∂ÈõÜÊâÄÊúâÁõ∏ÈóúÁØÄÈªû
            const nodeNames = new Set([centerNode]); // ‰∏ÄÂÆöÂåÖÂê´‰∏≠ÂøÉÁØÄÈªû
            filteredLinks.forEach(link => {
                nodeNames.add(link.from);
                nodeNames.add(link.to);
            });

            filteredNodes = sampleNodes.filter(node => nodeNames.has(node.name));
            consolidatedLinks = consolidateLinks(filteredLinks);
            
            // Êõ¥Êñ∞ÁØ©ÈÅ∏ÈÅ∏È†Ö
            updateFilterOptions();
            
            // Êõ¥Êñ∞Â±§Á¥öË≥áË®ä
            updateLayerInfo();
            
            if (document.getElementById('legend')) {
                updateLegend();
            }
        }
        
        // ÂïüÁî®ÁØ©ÈÅ∏ÊéßÂà∂È†Ö
        function enableFilterControls() {
            const yearContainer = document.getElementById('linkYearSelect');
            const typeContainer = document.getElementById('linkTypeSelect');
            const yearLabel = document.querySelector('label[for="linkYearSelect"]');
            const typeLabel = document.querySelector('label[for="linkTypeSelect"]');
            
            // ÁßªÈô§Á¶ÅÁî®Ê®£Âºè
            if (yearContainer) {
                yearContainer.style.opacity = '1';
                yearContainer.style.pointerEvents = 'auto';
            }
            if (typeContainer) {
                typeContainer.style.opacity = '1';
                typeContainer.style.pointerEvents = 'auto';
            }
            
            // ÂïüÁî®ÊâÄÊúâÁõ∏ÈóúÊåâÈàï
            document.querySelectorAll('.select-all-btn').forEach(btn => {
                btn.disabled = false;
                btn.style.opacity = '1';
            });
        }
        
        // Á¶ÅÁî®ÁØ©ÈÅ∏ÊéßÂà∂È†Ö
        function disableFilterControls() {
            const yearContainer = document.getElementById('linkYearSelect');
            const typeContainer = document.getElementById('linkTypeSelect');
            
            // Âä†ÂÖ•Á¶ÅÁî®Ê®£Âºè
            if (yearContainer) {
                yearContainer.style.opacity = '0.5';
                yearContainer.style.pointerEvents = 'none';
            }
            if (typeContainer) {
                typeContainer.style.opacity = '0.5';
                typeContainer.style.pointerEvents = 'none';
            }
            
            // Á¶ÅÁî®ÊâÄÊúâÁõ∏ÈóúÊåâÈàï
            document.querySelectorAll('.select-all-btn').forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.5';
            });
        }
        
        // Ê∏ÖÁ©∫ÁØ©ÈÅ∏ÈÅ∏È†Ö
        function clearFilterSelections() {
            // Ê∏ÖÁ©∫Âπ¥‰ªΩÈÅ∏Êìá
            const yearCheckboxes = document.querySelectorAll('#linkYearSelect input[type="checkbox"]');
            yearCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Ê∏ÖÁ©∫È°ûÂûãÈÅ∏Êìá
            const typeCheckboxes = document.querySelectorAll('#linkTypeSelect input[type="checkbox"]');
            typeCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
        }
        
        // Êõ¥Êñ∞ÁØ©ÈÅ∏ÈÅ∏È†ÖÔºàÂü∫ÊñºÁï∂Ââç‰∏≠ÂøÉÁØÄÈªûÁöÑÂèØÁî®ÈÅ∏È†ÖÔºâ
        function updateFilterOptions() {
            if (!centerNode) return;
            
            // ÊâæÂá∫Ëàá‰∏≠ÂøÉÁØÄÈªûÁõ∏ÈóúÁöÑÊâÄÊúâÈÄ£ÁµêÔºàÁï∂ÂâçÂ±§Á¥öÔºâ
            const centerNodeLinks = getLinksUpToLayer(centerNode, selectedLayers);
            
            // ÂèñÂæóÂèØÁî®ÁöÑÂπ¥‰ªΩÂíåÈ°ûÂûã
            const availableYears = [...new Set(centerNodeLinks.map(link => link.year))].sort((a, b) => b - a);
            const availableTypes = [...new Set(centerNodeLinks.map(link => link.type))];
            
            // Êõ¥Êñ∞Âπ¥‰ªΩÈÅ∏È†Ö - Âè™È°ØÁ§∫Áõ∏ÈóúÁöÑÂπ¥‰ªΩ
            updateSelectContainer('linkYearSelect', availableYears, 'linkYear');
            
            // Êõ¥Êñ∞È°ûÂûãÈÅ∏È†Ö - Âè™È°ØÁ§∫Áõ∏ÈóúÁöÑÈ°ûÂûã
            updateSelectContainer('linkTypeSelect', availableTypes, 'linkType');
        }
        
        // Êõ¥Êñ∞ÈÅ∏ÊìáÂÆπÂô®
        function updateSelectContainer(containerId, options, filterType) {
            const container = document.getElementById(containerId);
            container.innerHTML = ''; // Ê∏ÖÁ©∫ÁèæÊúâÂÖßÂÆπ
            
            options.forEach(option => {
                const item = document.createElement('div');
                item.className = 'checkbox-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `${filterType}_${option}`;
                checkbox.value = option;
                checkbox.checked = selectedFilters[filterType].includes(option);
                checkbox.addEventListener('change', () => updateFilter(filterType, option, checkbox.checked));
                
                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = option;
                
                item.appendChild(checkbox);
                item.appendChild(label);
                container.appendChild(item);
            });
        }
        
        // Ë®≠ÁΩÆÂ±§Á¥öÊéßÂà∂
        function setupLayerControls() {
            document.querySelectorAll('.layer-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    if (!initialNodeSelected) return; // Âè™ÊúâÂú®Â∑≤ÈÅ∏ÊìáÂàùÂßãÁØÄÈªûÂæåÊâçËÉΩ‰ΩøÁî®
                    
                    const layer = parseInt(e.target.dataset.layer);
                    selectedLayers = layer;
                    
                    // Êõ¥Êñ∞ÊåâÈàïÁãÄÊÖã
                    document.querySelectorAll('.layer-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    
                    // ÈáçÊñ∞ÁØ©ÈÅ∏Ë≥áÊñô
                    filterDataForCenterNode();
                    
                    // Êõ¥Êñ∞Ë¶ñË¶∫Âåñ
                    updateVisualization();
                });
            });
        }
        
        // ÂïüÁî®Â±§Á¥öÊéßÂà∂
        function enableLayerControls() {
            const layerControls = document.getElementById('layerControls');
            if (layerControls) {
                layerControls.style.opacity = '1';
                layerControls.style.pointerEvents = 'auto';
            }
            
            document.querySelectorAll('.layer-btn').forEach(btn => {
                btn.disabled = false;
            });
        }
        
        // Á¶ÅÁî®Â±§Á¥öÊéßÂà∂
        function disableLayerControls() {
            const layerControls = document.getElementById('layerControls');
            if (layerControls) {
                layerControls.style.opacity = '0.5';
                layerControls.style.pointerEvents = 'none';
            }
            
            document.querySelectorAll('.layer-btn').forEach(btn => {
                btn.disabled = true;
            });
            
            // ÈáçÁΩÆÁÇ∫Á¨¨‰∏ÄÂ±§
            document.querySelectorAll('.layer-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('.layer-btn[data-layer="1"]').classList.add('active');
            selectedLayers = 1;
        }
        
        // Áç≤ÂèñÊåáÂÆöÂ±§Á¥öÁöÑÊâÄÊúâÈÄ£Áµê
        function getLinksUpToLayer(centerNodeName, maxLayers) {
            if (maxLayers <= 0) return [];
            
            const visitedNodes = new Set();
            const resultLinks = [];
            let currentLayerNodes = new Set([centerNodeName]);
            
            for (let layer = 1; layer <= maxLayers; layer++) {
                const nextLayerNodes = new Set();
                
                currentLayerNodes.forEach(nodeName => {
                    if (visitedNodes.has(nodeName)) return;
                    visitedNodes.add(nodeName);
                    
                    // ÊâæÂá∫ËàáÁï∂ÂâçÁØÄÈªûÈÄ£Êé•ÁöÑÊâÄÊúâÈÄ£Áµê
                    const nodeLinks = sampleLinks.filter(link => 
                        link.from === nodeName || link.to === nodeName
                    );
                    
                    nodeLinks.forEach(link => {
                        // ÈÅøÂÖçÈáçË§áÊ∑ªÂä†Áõ∏ÂêåÁöÑÈÄ£Áµê
                        const linkKey = `${link.from}-${link.to}-${link.type}-${link.year}`;
                        const reverseLinkKey = `${link.to}-${link.from}-${link.type}-${link.year}`;
                        
                        const isDuplicate = resultLinks.some(existingLink => {
                            const existingKey = `${existingLink.from}-${existingLink.to}-${existingLink.type}-${existingLink.year}`;
                            const existingReverseKey = `${existingLink.to}-${existingLink.from}-${existingLink.type}-${existingLink.year}`;
                            return existingKey === linkKey || existingReverseKey === linkKey || 
                                   existingKey === reverseLinkKey || existingReverseKey === reverseLinkKey;
                        });
                        
                        if (!isDuplicate) {
                            resultLinks.push(link);
                        }
                        
                        // Ê∑ªÂä†‰∏ã‰∏ÄÂ±§ÁöÑÁØÄÈªû
                        if (layer < maxLayers) {
                            const otherNode = link.from === nodeName ? link.to : link.from;
                            if (!visitedNodes.has(otherNode)) {
                                nextLayerNodes.add(otherNode);
                            }
                        }
                    });
                });
                
                // Ê∫ñÂÇô‰∏ã‰∏ÄÂ±§
                currentLayerNodes = nextLayerNodes;
                
                if (currentLayerNodes.size === 0) break; // Ê≤íÊúâÊõ¥Â§öÁØÄÈªû‰∫Ü
            }
            
            return resultLinks;
        }
        
        // Êõ¥Êñ∞Â±§Á¥öË≥áË®ä
        function updateLayerInfo() {
            const layerInfo = document.getElementById('layerInfo');
            if (!layerInfo) return;
            
            if (!centerNode) {
                layerInfo.textContent = 'ÈÅ∏Êìá‰∏≠ÂøÉÁØÄÈªûÂæåÂèØË™øÊï¥Â±§Á¥ö';
                return;
            }
            
            const nodeCount = filteredNodes.length - 1; // Ê∏õÂéª‰∏≠ÂøÉÁØÄÈªû
            const linkCount = filteredLinks.length;
            layerInfo.textContent = `Á¨¨${selectedLayers}Â±§Ôºö${nodeCount}ÂÄãÁØÄÈªûÔºå${linkCount}ÂÄãÈÄ£Áµê`;
        }

        // ÂâµÂª∫Ë¶ñË¶∫Âåñ
        function createVisualization() {
            const container = document.getElementById('network-container');
            const width = container.clientWidth;
            const height = container.clientHeight;

            console.log('Creating visualization:', width, height);
            console.log('Filtered nodes:', filteredNodes.length);
            console.log('Filtered links:', filteredLinks.length);
            console.log('Consolidated links:', consolidatedLinks.length);

            // Ê∏ÖÈô§ÂàùÂßãË®äÊÅØÂíåËàäÁöÑ SVG
            d3.select('#network-container .initial-message').remove();
            d3.select('#network-container svg').remove();

            svg = d3.select('#network-container')
                .append('svg')
                .attr('width', width)
                .attr('height', height)
                .style('background', '#f8f9fa');

            zoom = d3.zoom()
                .scaleExtent([0.1, 10])
                .on('zoom', (event) => {
                    g.attr('transform', event.transform);
                });

            svg.call(zoom);

            g = svg.append('g');

            tooltip = d3.select('#tooltip');

            updateVisualization();
        }

        // Áç≤ÂèñËàáÁõÆÊ®ôÁØÄÈªûÁõ∏ÈóúÁöÑÈÄ£Áµê
        function getRelatedLinks(targetNodeName) {
            return consolidatedLinks.filter(link => 
                link.from === targetNodeName || link.to === targetNodeName
            );
        }

        // Áç≤ÂèñËàáÁõÆÊ®ôÁØÄÈªûÁõ∏ÈÄ£ÁöÑÁØÄÈªû
        function getConnectedNodes(targetNodeName) {
            const connectedNodeNames = new Set();
            const relatedLinks = getRelatedLinks(targetNodeName);
            
            relatedLinks.forEach(link => {
                connectedNodeNames.add(link.from);
                connectedNodeNames.add(link.to);
            });
            
            return filteredNodes.filter(node => 
                connectedNodeNames.has(node.name)
            );
        }

        // Êõ¥Êñ∞Ë¶ñË¶∫Âåñ
        function updateVisualization() {
            if (!g) return; // Â¶ÇÊûú g ÈÇÑÊ≤íÂàùÂßãÂåñÔºåÂ∞±Áõ¥Êé•ËøîÂõû
            
            const container = document.getElementById('network-container');
            const width = container.clientWidth;
            const height = container.clientHeight;

            console.log('Updating visualization:', currentLayout);
            console.log('Container size:', width, height);

            g.selectAll("*").remove();

            if (filteredNodes.length === 0) {
                g.append('text')
                    .attr('x', width / 2)
                    .attr('y', height / 2)
                    .attr('text-anchor', 'middle')
                    .attr('font-size', '18px')
                    .attr('fill', '#666')
                    .text('Ë´ãÈÅ∏ÊìáÂπ¥‰ªΩÂíåÈÄ£ÁµêÈ°ûÂûã‰ª•È°ØÁ§∫Ë≥áÊñô');
                return;
            }

            consolidatedLinks = consolidateLinks(filteredLinks);

            if (currentLayout === 'force') {
                createForceLayout(width, height);
            } else {
                createCircleLayout(width, height);
            }
        }

        // ForceÂ∏ÉÂ±Ä
        function createForceLayout(width, height) {
            const linkData = consolidatedLinks.map(d => ({
                source: d.from,
                target: d.to,
                type: d.type,
                year: d.year,
                url: d.url,
                from: d.from,
                to: d.to,
                entries: d.entries,
                allTypes: d.allTypes,
                allYears: d.allYears,
                isMultiLink: d.isMultiLink,
                linkCount: d.linkCount
            }));

            simulation = d3.forceSimulation(filteredNodes)
                .force('link', d3.forceLink(linkData).id(d => d.name).distance(100))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(30));

            // Â¶ÇÊûúÊúâÊêúÂ∞ãÁöÑÁØÄÈªûÔºåÁç≤ÂèñÁõ∏ÈóúÁöÑÈÄ£ÁµêÂíåÁØÄÈªû
            let relatedLinks = [];
            let connectedNodes = [];
            if (searchedNode) {
                relatedLinks = getRelatedLinks(searchedNode);
                connectedNodes = getConnectedNodes(searchedNode);
            }

            const link = g.append('g')
                .selectAll('line')
                .data(linkData)
                .enter().append('line')
                .attr('class', d => {
                    let classes = `link ${d.isMultiLink ? 'multi-link' : ''}`;
                    if (searchedNode && !relatedLinks.some(rl => 
                        rl.from === d.from && rl.to === d.to)) {
                        classes += ' dimmed';
                    }
                    return classes;
                })
                .attr('stroke', d => linkColors[d.type] || '#999')
                .attr('stroke-width', d => d.isMultiLink ? 3 : 2)
                .on('mouseover', showTooltip)
                .on('mouseout', hideTooltip)
                .on('click', function(event, d) {
                    event.stopPropagation();
                    showFixedTooltip(event, d);
                });

            const node = g.append('g')
                .selectAll('circle')
                .data(filteredNodes)
                .enter().append('circle')
                .attr('class', d => {
                    let classes = 'node';
                    if (searchedNode) {
                        if (d.name === searchedNode) {
                            classes += ' focused';
                        } else if (!connectedNodes.some(cn => cn.name === d.name)) {
                            classes += ' dimmed';
                        }
                    }
                    return classes;
                })
                .attr('r', d => d.name === searchedNode ? 25 : 20)
                .attr('fill', d => nodeColors[d.type] || '#999')
                .on('mouseover', function(event, d) {
                    tooltip
                        .style('display', 'block')
                        .html(`
                            <h4>ÁØÄÈªûË≥áË®ä</h4>
                            <p><strong>ÂêçÁ®±:</strong> ${d.name}</p>
                            <p><strong>È°ûÂûã:</strong> ${d.type}</p>
                        `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    if (!fixedTooltip) {
                        tooltip.style('display', 'none');
                    }
                })
                .on('click', function(event, d) {
                    // ÈªûÊìäÁØÄÈªûÊôÇÂ∞áÂÖ∂Ë®≠ÁÇ∫ÊêúÂ∞ãÁõÆÊ®ô
                    searchedNode = d.name;
                    document.getElementById('nodeSearch').value = d.name;
                    updateVisualization();
                    centerOnNode(d);
                })
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));

            const nodeText = g.append('g')
                .selectAll('text')
                .data(filteredNodes)
                .enter().append('text')
                .attr('class', d => {
                    let classes = 'node-text';
                    if (searchedNode && d.name !== searchedNode && 
                        !connectedNodes.some(cn => cn.name === d.name)) {
                        classes += ' dimmed';
                    }
                    return classes;
                })
                .text(d => d.name)
                .style('pointer-events', 'none')
                .style('font-size', d => d.name === searchedNode ? '12px' : '11px')
                .style('font-weight', d => d.name === searchedNode ? 'bold' : '600');

            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                node
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);

                nodeText
                    .attr('x', d => d.x)
                    .attr('y', d => d.y);
            });
        }

        // CircleÂ∏ÉÂ±Ä
        function createCircleLayout(width, height) {
            const radius = Math.min(width, height) / 2 - 50;
            const center = { x: width / 2, y: height / 2 };

            // Â¶ÇÊûúÊúâÊêúÂ∞ãÁöÑÁØÄÈªûÔºåÂ∞áÂÖ∂ÊîæÂú®‰∏≠ÂøÉ
            let nodePositions;
            if (searchedNode) {
                const targetNodeIndex = filteredNodes.findIndex(node => node.name === searchedNode);
                const connectedNodes = getConnectedNodes(searchedNode);
                
                nodePositions = filteredNodes.map((node, i) => {
                    if (node.name === searchedNode) {
                        return {
                            ...node,
                            x: center.x,
                            y: center.y
                        };
                    } else if (connectedNodes.some(cn => cn.name === node.name)) {
                        // Áõ∏ÈÄ£ÁöÑÁØÄÈªûÂúçÁπûÂú®ÁõÆÊ®ôÁØÄÈªûÂë®Âúç
                        const connectedIndex = connectedNodes.findIndex(cn => cn.name === node.name);
                        const angle = (connectedIndex / (connectedNodes.length - 1)) * 2 * Math.PI;
                        const nodeRadius = radius * 0.6;
                        return {
                            ...node,
                            x: center.x + nodeRadius * Math.cos(angle),
                            y: center.y + nodeRadius * Math.sin(angle)
                        };
                    } else {
                        // ÂÖ∂‰ªñÁØÄÈªûÊîæÂú®Â§ñÂúà
                        const otherNodes = filteredNodes.filter(n => 
                            n.name !== searchedNode && 
                            !connectedNodes.some(cn => cn.name === n.name)
                        );
                        const otherIndex = otherNodes.findIndex(n => n.name === node.name);
                        const angle = (otherIndex / otherNodes.length) * 2 * Math.PI;
                        return {
                            ...node,
                            x: center.x + radius * Math.cos(angle),
                            y: center.y + radius * Math.sin(angle)
                        };
                    }
                });
            } else {
                nodePositions = filteredNodes.map((node, i) => {
                    const angle = (i / filteredNodes.length) * 2 * Math.PI;
                    return {
                        ...node,
                        x: center.x + radius * Math.cos(angle),
                        y: center.y + radius * Math.sin(angle)
                    };
                });
            }

            const linkData = consolidatedLinks.map(d => {
                const sourceNode = nodePositions.find(n => n.name === d.from);
                const targetNode = nodePositions.find(n => n.name === d.to);
                return {
                    ...d,
                    source: sourceNode,
                    target: targetNode,
                    x1: sourceNode ? sourceNode.x : 0,
                    y1: sourceNode ? sourceNode.y : 0,
                    x2: targetNode ? targetNode.x : 0,
                    y2: targetNode ? targetNode.y : 0
                };
            }).filter(d => d.source && d.target);

            // Áç≤ÂèñÁõ∏ÈóúÈÄ£ÁµêÔºàÂ¶ÇÊûúÊúâÊêúÂ∞ãÁØÄÈªûÔºâ
            let relatedLinks = [];
            let connectedNodes = [];
            if (searchedNode) {
                relatedLinks = getRelatedLinks(searchedNode);
                connectedNodes = getConnectedNodes(searchedNode);
            }

            const link = g.append('g')
                .selectAll('line')
                .data(linkData)
                .enter().append('line')
                .attr('class', d => {
                    let classes = `link ${d.isMultiLink ? 'multi-link' : ''}`;
                    if (searchedNode && !relatedLinks.some(rl => 
                        rl.from === d.from && rl.to === d.to)) {
                        classes += ' dimmed';
                    }
                    return classes;
                })
                .attr('stroke', d => linkColors[d.type] || '#999')
                .attr('stroke-width', d => d.isMultiLink ? 3 : 2)
                .attr('x1', d => d.x1)
                .attr('y1', d => d.y1)
                .attr('x2', d => d.x2)
                .attr('y2', d => d.y2)
                .on('mouseover', showTooltip)
                .on('mouseout', hideTooltip)
                .on('click', function(event, d) {
                    event.stopPropagation();
                    showFixedTooltip(event, d);
                });

            const node = g.append('g')
                .selectAll('circle')
                .data(nodePositions)
                .enter().append('circle')
                .attr('class', d => {
                    let classes = 'node';
                    if (searchedNode) {
                        if (d.name === searchedNode) {
                            classes += ' focused';
                        } else if (!connectedNodes.some(cn => cn.name === d.name)) {
                            classes += ' dimmed';
                        }
                    }
                    return classes;
                })
                .attr('r', d => d.name === searchedNode ? 25 : 20)
                .attr('fill', d => nodeColors[d.type] || '#999')
                .attr('cx', d => d.x)
                .attr('cy', d => d.y)
                .on('mouseover', function(event, d) {
                    tooltip
                        .style('display', 'block')
                        .html(`
                            <h4>ÁØÄÈªûË≥áË®ä</h4>
                            <p><strong>ÂêçÁ®±:</strong> ${d.name}</p>
                            <p><strong>È°ûÂûã:</strong> ${d.type}</p>
                        `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    if (!fixedTooltip) {
                        tooltip.style('display', 'none');
                    }
                })
                .on('click', function(event, d) {
                    // ÈªûÊìäÁØÄÈªûÊôÇÂ∞áÂÖ∂Ë®≠ÁÇ∫ÊêúÂ∞ãÁõÆÊ®ô
                    searchedNode = d.name;
                    document.getElementById('nodeSearch').value = d.name;
                    updateVisualization();
                    centerOnNode(d);
                });

            const nodeText = g.append('g')
                .selectAll('text')
                .data(nodePositions)
                .enter().append('text')
                .attr('class', d => {
                    let classes = 'node-text';
                    if (searchedNode && d.name !== searchedNode && 
                        !connectedNodes.some(cn => cn.name === d.name)) {
                        classes += ' dimmed';
                    }
                    return classes;
                })
                .text(d => d.name)
                .attr('x', d => d.x)
                .attr('y', d => d.y)
                .style('pointer-events', 'none')
                .style('font-size', d => d.name === searchedNode ? '12px' : '11px')
                .style('font-weight', d => d.name === searchedNode ? 'bold' : '600');
        }

        // Tooltip functions
        function showTooltip(event, d) {
            if (fixedTooltip) return;
            
            let tooltipHTML = `<h4>ÈÄ£ÁµêË≥áË®ä</h4>`;
            tooltipHTML += `<p><strong>Ëµ∑Èªû:</strong> ${d.from}</p>`;
            tooltipHTML += `<p><strong>ÁµÇÈªû:</strong> ${d.to}</p>`;
            
            if (d.isMultiLink) {
                tooltipHTML += `<p><strong>ÈÄ£ÁµêÊï∏Èáè:</strong> ${d.linkCount}</p>`;
                tooltipHTML += `<div style="margin-top: 10px;">`;
                d.entries.forEach((entry, index) => {
                    tooltipHTML += `
                        <div class="link-entry">
                            <p><strong>È°ûÂûã ${index + 1}:</strong> ${entry.type}</p>
                            <p><strong>Âπ¥‰ªΩ:</strong> ${entry.year}</p>
                            <p><strong>ÂèÉËÄÉ:</strong> <a href="${entry.url}" target="_blank" rel="noopener noreferrer">Êü•ÁúãË©≥ÊÉÖ</a></p>
                        </div>
                    `;
                });
                tooltipHTML += `</div>`;
            } else {
                tooltipHTML += `<p><strong>È°ûÂûã:</strong> ${d.type}</p>`;
                tooltipHTML += `<p><strong>Âπ¥‰ªΩ:</strong> ${d.year}</p>`;
                tooltipHTML += `<p><strong>ÂèÉËÄÉ:</strong> <a href="${d.url}" target="_blank" rel="noopener noreferrer">Êü•ÁúãË©≥ÊÉÖ</a></p>`;
            }
            
            tooltip
                .style('display', 'block')
                .html(tooltipHTML)
                .style('left', (event.pageX + 10) + 'px')
                .style('top', (event.pageY - 10) + 'px');
        }

        function hideTooltip() {
            if (!fixedTooltip && tooltip) { // Ê™¢Êü• tooltip ÊòØÂê¶Â≠òÂú®
                tooltip.style('display', 'none');
            }
        }

        function showFixedTooltip(event, d) {
            fixedTooltip = d;
            
            let tooltipHTML = `<h4>ÈÄ£ÁµêË≥áË®ä (ÈªûÊìäÁ©∫ÁôΩËôïÈóúÈñâ)</h4>`;
            tooltipHTML += `<p><strong>Ëµ∑Èªû:</strong> ${d.from}</p>`;
            tooltipHTML += `<p><strong>ÁµÇÈªû:</strong> ${d.to}</p>`;
            
            if (d.isMultiLink) {
                tooltipHTML += `<p><strong>ÈÄ£ÁµêÊï∏Èáè:</strong> ${d.linkCount}</p>`;
                tooltipHTML += `<div style="margin-top: 10px;">`;
                d.entries.forEach((entry, index) => {
                    tooltipHTML += `
                        <div class="link-entry">
                            <p><strong>È°ûÂûã ${index + 1}:</strong> ${entry.type}</p>
                            <p><strong>Âπ¥‰ªΩ:</strong> ${entry.year}</p>
                            <p><strong>ÂèÉËÄÉ:</strong> <a href="${entry.url}" target="_blank" rel="noopener noreferrer" class="tooltip-link">Êü•ÁúãË©≥ÊÉÖ</a></p>
                        </div>
                    `;
                });
                tooltipHTML += `</div>`;
            } else {
                tooltipHTML += `<p><strong>È°ûÂûã:</strong> ${d.type}</p>`;
                tooltipHTML += `<p><strong>Âπ¥‰ªΩ:</strong> ${d.year}</p>`;
                tooltipHTML += `<p><strong>ÂèÉËÄÉ:</strong> <a href="${d.url}" target="_blank" rel="noopener noreferrer" class="tooltip-link">Êü•ÁúãË©≥ÊÉÖ</a></p>`;
            }
            
            tooltip
                .style('display', 'block')
                .html(tooltipHTML)
                .style('left', (event.pageX + 10) + 'px')
                .style('top', (event.pageY - 10) + 'px');
                
            setTimeout(() => {
                const links = tooltip.selectAll('.tooltip-link').nodes();
                links.forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.stopPropagation();
                        window.open(this.href, '_blank', 'noopener,noreferrer');
                    });
                });
            }, 0);
        }

        function hideFixedTooltip() {
            fixedTooltip = null;
            if (tooltip) { // Ê™¢Êü• tooltip ÊòØÂê¶Â≠òÂú®
                tooltip.style('display', 'none');
            }
        }

        // ÊãñÊãΩÂäüËÉΩ
        function dragstarted(event, d) {
            if (!event.active && simulation) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active && simulation) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        // Êõ¥Êñ∞Âúñ‰æã
        function updateLegend() {
            const legendContent = document.getElementById('legend-content');
            
            let legendHTML = '';

            // Âè™ÊúâÂú®ÊúâË≥áÊñôÊôÇÊâçÈ°ØÁ§∫Âúñ‰æãÂÖßÂÆπ
            if (filteredNodes.length > 0 || filteredLinks.length > 0) {
                // ÁØÄÈªûÈ°ûÂûãÂçÄÂ°ä
                const visibleNodeTypes = [...new Set(filteredNodes.map(node => node.type))];
                if (visibleNodeTypes.length > 0) {
                    legendHTML += '<div class="legend-section">';
                    legendHTML += '<h5>ÁØÄÈªûÈ°ûÂûã</h5>';
                    visibleNodeTypes.forEach(type => {
                        const color = nodeColors[type] || '#999';
                        legendHTML += `
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: ${color}"></div>
                                <span>${type}</span>
                            </div>
                        `;
                    });
                    legendHTML += '</div>';
                }

                // ÈÄ£ÁµêÈ°ûÂûãÂçÄÂ°ä
                const visibleLinkTypes = [...new Set(filteredLinks.map(link => link.type))];
                if (visibleLinkTypes.length > 0) {
                    legendHTML += '<div class="legend-section">';
                    legendHTML += '<h5>ÈÄ£ÁµêÈ°ûÂûã</h5>';
                    visibleLinkTypes.forEach(type => {
                        const color = linkColors[type] || '#999';
                        legendHTML += `
                            <div class="legend-item">
                                <div class="legend-line" style="background-color: ${color};"></div>
                                <span>${type}</span>
                            </div>
                        `;
                    });
                    legendHTML += '</div>';
                }

                // ÈÄ£ÁµêÊ®£ÂºèÂçÄÂ°ä
                if (consolidatedLinks.some(link => link.isMultiLink)) {
                    legendHTML += '<div class="legend-section">';
                    legendHTML += '<h5>ÈÄ£ÁµêÊ®£Âºè</h5>';
                    legendHTML += `
                        <div class="legend-item">
                            <div class="legend-dashed"></div>
                            <span>Â§öÈáçÈÄ£Áµê</span>
                        </div>
                    `;
                    legendHTML += '</div>';
                }

                // ÊêúÂ∞ãÁãÄÊÖãË™™Êòé
                if (searchedNode) {
                    legendHTML += '<div class="legend-section">';
                    legendHTML += '<h5>ÊêúÂ∞ãÁãÄÊÖã</h5>';
                    legendHTML += `
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #667eea; border: 2px solid #667eea;"></div>
                            <span>ËÅöÁÑ¶ÁØÄÈªû</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #ccc; opacity: 0.5;"></div>
                            <span>ÈùûÁõ∏ÈóúÁØÄÈªû</span>
                        </div>
                    `;
                    legendHTML += '</div>';
                }
            } else {
                // Ê≤íÊúâË≥áÊñôÊôÇÈ°ØÁ§∫ÊèêÁ§∫
                legendHTML = '<div style="text-align: center; color: #999; padding: 20px; font-size: 14px;">ÈÅ∏ÊìáÁØ©ÈÅ∏Ê¢ù‰ª∂ÂæåÂ∞áÈ°ØÁ§∫Âúñ‰æã</div>';
            }

            legendContent.innerHTML = legendHTML;
        }

        // Ë¶ñÁ™óÂ§ßÂ∞èÊîπËÆäÊôÇÈáçÊñ∞Áπ™Ë£Ω
        window.addEventListener('resize', () => {
            setTimeout(createVisualization, 100);
        });

        // ÂïüÂãïÊáâÁî®Á®ãÂºè
        loadData();
    </script>
</body>
</html>